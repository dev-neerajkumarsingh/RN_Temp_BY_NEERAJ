stages:
  - lint-checks

# Global variables for the pipeline
variables:
  GIT_DEPTH: "0" # Required to analyze commit history and branch diffs

# Standardized job for all MR compliance rules
compliance_checks:
  stage: lint-checks
  image: alpine:latest
  before_script:
    - apk add --no-cache git bash
    - git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
  script:
    - echo "üöÄ Starting Compliance Checks for MR..."

    # --- 1. BRANCH NAMING CONVENTION CHECK ---
    - echo "üîç Checking branch naming convention..."
    - |
      if [[ ! "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" =~ ^(feature/|bugFix/) ]]; then
        echo "‚ùå FAILURE: Invalid branch name: '$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME'"
        echo "   Rule: Branch names must start with 'feature/' or 'bugFix/'"
        exit 1
      fi
    - echo "‚úÖ Branch name follows guidelines."

    # --- 2. MR SIZE LIMIT CHECK (50 FILES) ---
    - echo "üîç Checking MR size..."
    - COUNTABLE_FILES=$(git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...$CI_COMMIT_SHA | grep -vE '\.(png|jpg|jpeg|gif|webp|svg|ttf|otf|woff|woff2)$' | wc -l)
    - |
      if [ "$COUNTABLE_FILES" -gt 50 ]; then
        echo "‚ùå FAILURE: Merge Request too large ($COUNTABLE_FILES files)."
        echo "   Rule: Max 50 files (excluding assets/fonts). Please split your MR."
        exit 1
      fi
    - echo "‚úÖ MR size is within limits ($COUNTABLE_FILES files)."

    # --- 3. CONVENTIONAL COMMITS CHECK ---
    - echo "üîç Checking commit message formats..."
    # Gets all commit messages unique to this feature branch
    - COMMITS=$(git log origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME..$CI_COMMIT_SHA --pretty=format:"%s")
    - |
      while IFS= read -r msg; do
        if [[ ! "$msg" =~ ^(feat|fix|chore|docs|style|refactor|perf|test)(\(.*\))?!?: .+$ ]]; then
          echo "‚ùå FAILURE: Invalid commit message: '$msg'"
          echo "   Rule: Use Conventional Commits (e.g., 'feat: add login' or 'fix(ui): button alignment')"
          exit 1
        fi
      done <<< "$COMMITS"
    - echo "‚úÖ All commit messages follow Conventional Commits."

  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'